{% extends "base.html" %}
{% block title %}EY{% endblock %}
{% block content %}
<div class="page-header">
    <h1 class="page-title">Change Password</h1>
    <a href="{{ url_for('settings') }}" class="btn btn-secondary">
        ‚Üê Back to Settings
    </a>
</div>

<div class="card">
    <form method="POST" id="changePasswordForm">
        <div class="form-group">
            <label class="form-label">Current Password</label>
            <input type="password" name="current_password" id="currentPassword" class="form-control" placeholder="Enter your current password" required>
        </div>
        
        <div class="form-group">
            <label class="form-label">New Password</label>
            <input type="password" name="new_password" id="newPassword" class="form-control" placeholder="Enter new password (min. 6 characters)" required minlength="6">
            <small class="password-help">Password must be at least 6 characters long</small>
        </div>
        
        <div class="form-group">
            <label class="form-label">Confirm New Password</label>
            <input type="password" name="confirm_password" id="confirmPassword" class="form-control" placeholder="Confirm new password" required>
            <small id="passwordMatch" class="password-match"></small>
        </div>
        
        <div class="password-strength" id="passwordStrength">
            <div class="strength-bar">
                <div class="strength-fill" id="strengthFill"></div>
            </div>
            <span class="strength-text" id="strengthText">Enter a password</span>
        </div>
        
        <div class="form-actions">
            <button type="submit" class="btn btn-primary" id="submitBtn">
                üîí Change Password
            </button>
            <a href="{{ url_for('settings') }}" class="btn btn-secondary">
                Cancel
            </a>
        </div>
    </form>
</div>

<div class="card">
    <h3>Password Security Tips</h3>
    <ul class="security-tips">
        <li>Use at least 8 characters (minimum 6 required)</li>
        <li>Include both uppercase and lowercase letters</li>
        <li>Add numbers and special characters</li>
        <li>Avoid common words or personal information</li>
        <li>Don't reuse passwords from other accounts</li>
    </ul>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const newPassword = document.getElementById('newPassword');
    const confirmPassword = document.getElementById('confirmPassword');
    const passwordMatch = document.getElementById('passwordMatch');
    const strengthFill = document.getElementById('strengthFill');
    const strengthText = document.getElementById('strengthText');
    const submitBtn = document.getElementById('submitBtn');
    const form = document.getElementById('changePasswordForm');

    // Password strength checker
    function checkPasswordStrength(password) {
        let strength = 0;
        let feedback = '';

        if (password.length >= 6) strength += 1;
        if (password.length >= 8) strength += 1;
        if (/[a-z]/.test(password)) strength += 1;
        if (/[A-Z]/.test(password)) strength += 1;
        if (/[0-9]/.test(password)) strength += 1;
        if (/[^A-Za-z0-9]/.test(password)) strength += 1;

        switch (strength) {
            case 0:
            case 1:
                feedback = 'Very Weak';
                strengthFill.style.width = '20%';
                strengthFill.style.backgroundColor = '#dc3545';
                break;
            case 2:
                feedback = 'Weak';
                strengthFill.style.width = '40%';
                strengthFill.style.backgroundColor = '#fd7e14';
                break;
            case 3:
                feedback = 'Fair';
                strengthFill.style.width = '60%';
                strengthFill.style.backgroundColor = '#ffc107';
                break;
            case 4:
                feedback = 'Good';
                strengthFill.style.width = '80%';
                strengthFill.style.backgroundColor = '#28a745';
                break;
            case 5:
            case 6:
                feedback = 'Strong';
                strengthFill.style.width = '100%';
                strengthFill.style.backgroundColor = '#20c997';
                break;
        }

        strengthText.textContent = feedback;
        return strength;
    }

    // Password match checker
    function checkPasswordMatch() {
        if (confirmPassword.value === '') {
            passwordMatch.textContent = '';
            passwordMatch.className = 'password-match';
            return true;
        }

        if (newPassword.value === confirmPassword.value) {
            passwordMatch.textContent = '‚úì Passwords match';
            passwordMatch.className = 'password-match match';
            return true;
        } else {
            passwordMatch.textContent = '‚úó Passwords do not match';
            passwordMatch.className = 'password-match no-match';
            return false;
        }
    }

    // Event listeners
    newPassword.addEventListener('input', function() {
        checkPasswordStrength(this.value);
        checkPasswordMatch();
    });

    confirmPassword.addEventListener('input', checkPasswordMatch);

    // Form validation
    form.addEventListener('submit', function(e) {
        const strength = checkPasswordStrength(newPassword.value);
        const match = checkPasswordMatch();

        if (!match) {
            e.preventDefault();
            showNotification('Passwords do not match', 'error');
            return false;
        }

        if (newPassword.value.length < 6) {
            e.preventDefault();
            showNotification('Password must be at least 6 characters long', 'error');
            return false;
        }

        if (strength < 2) {
            if (!confirm('Your password is weak. Are you sure you want to continue?')) {
                e.preventDefault();
                return false;
            }
        }
    });
});
</script>
{% endblock %}