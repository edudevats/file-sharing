{% extends "base.html" %}
{% block title %}EY{% endblock %}
{% block content %}
<div class="page-header">
    <h1 class="page-title">Create File Bundle</h1>
    <a href="{{ url_for('dashboard') }}" class="btn btn-secondary">
        ‚Üê Back to Dashboard
    </a>
</div>

<div class="card">
    <form method="POST" id="bundleForm">
        <div class="form-group">
            <label class="form-label">Bundle Name</label>
            <input type="text" name="bundle_name" class="form-control" placeholder="Enter bundle name" required>
            <small class="form-help">Internal name for this bundle</small>
        </div>
        
        <div class="form-group">
            <label class="form-label">Transaction Number</label>
            <input type="text" name="transaction_number" id="transactionNumber" class="form-control" placeholder="Enter transaction number" required>
            <small class="form-help">This will be used as the title when sharing the bundle. Files with the same transaction number will be auto-selected.</small>
        </div>
        
        <div class="form-group">
            <div class="checkbox-group">
                <input type="checkbox" name="is_public" id="isPublic">
                <label for="isPublic">
                    <strong>Make public</strong> - Anyone with the link will be able to access
                </label>
            </div>
        </div>
        
        <div class="form-group">
            <label class="form-label">Select Files</label>
            <div class="file-selection-grid">
                {% if files %}
                    {% for file in files %}
                    <div class="file-selection-item">
                        <div class="checkbox-group file-checkbox">
                            <input type="checkbox" name="selected_files" value="{{ file.id }}" id="file_{{ file.id }}">
                            <label for="file_{{ file.id }}" class="file-item-label">
                                <div class="file-icon-small">
                                    {% if file.file_type == 'pdf' %}üìÑ
                                    {% elif file.file_type in ['jpg', 'jpeg', 'png', 'gif'] %}üñºÔ∏è
                                    {% elif file.file_type in ['doc', 'docx'] %}üìù
                                    {% elif file.file_type == 'zip' %}üóúÔ∏è
                                    {% else %}üìÅ{% endif %}
                                </div>
                                <div class="file-details-small">
                                    <strong>{{ file.transaction_number if file.transaction_number else file.original_filename }}</strong>
                                    <small>{{ file.original_filename }} ‚Ä¢ {{ (file.file_size / 1024) | round(2) }} KB</small>
                                </div>
                            </label>
                        </div>
                    </div>
                    {% endfor %}
                {% else %}
                    <div class="empty-state">
                        <div class="empty-icon">üìÅ</div>
                        <h3>No files available</h3>
                        <p>Upload some files first to create a bundle</p>
                        <a href="{{ url_for('upload') }}" class="btn btn-primary">Upload Files</a>
                    </div>
                {% endif %}
            </div>
            
            {% if files %}
            <div class="selection-actions">
                <button type="button" class="btn btn-secondary btn-sm" onclick="selectAll()">Select All</button>
                <button type="button" class="btn btn-secondary btn-sm" onclick="selectNone()">Select None</button>
                <button type="button" class="btn btn-info btn-sm" onclick="selectByTransaction()">üìã Auto-Select by Transaction</button>
                <span id="selectedCount" class="selected-count">0 files selected</span>
            </div>
            {% endif %}
        </div>
        
        {% if files %}
        <div class="form-actions">
            <button type="submit" class="btn btn-primary" id="createBtn">
                üì¶ Create Bundle
            </button>
            <a href="{{ url_for('dashboard') }}" class="btn btn-secondary">
                Cancel
            </a>
        </div>
        {% endif %}
    </form>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const checkboxes = document.querySelectorAll('input[name="selected_files"]');
    const selectedCount = document.getElementById('selectedCount');
    const createBtn = document.getElementById('createBtn');
    const transactionInput = document.getElementById('transactionNumber');
    
    function updateCount() {
        const checked = document.querySelectorAll('input[name="selected_files"]:checked').length;
        selectedCount.textContent = `${checked} files selected`;
        createBtn.disabled = checked === 0;
    }
    
    // Auto-select files by transaction number
    function selectByTransaction() {
        const transactionNumber = transactionInput.value.trim();
        if (!transactionNumber) return;
        
        // First, uncheck all files
        checkboxes.forEach(cb => cb.checked = false);
        
        // Find and check files with matching transaction number
        let matchCount = 0;
        checkboxes.forEach(cb => {
            const fileRow = cb.closest('.file-selection-item');
            const label = fileRow.querySelector('.file-item-label');
            const transactionText = label.querySelector('strong').textContent;
            
            if (transactionText === transactionNumber) {
                cb.checked = true;
                matchCount++;
            }
        });
        
        updateCount();
        
        if (matchCount > 0) {
            selectedCount.textContent = `${matchCount} files auto-selected for transaction "${transactionNumber}"`;
            selectedCount.style.color = 'var(--success)';
            setTimeout(() => {
                selectedCount.style.color = '';
                updateCount();
            }, 3000);
        }
    }
    
    // Listen for transaction number changes
    transactionInput.addEventListener('blur', selectByTransaction);
    transactionInput.addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
            e.preventDefault();
            selectByTransaction();
        }
    });
    
    checkboxes.forEach(cb => cb.addEventListener('change', updateCount));
    
    window.selectAll = function() {
        checkboxes.forEach(cb => cb.checked = true);
        updateCount();
    };
    
    window.selectNone = function() {
        checkboxes.forEach(cb => cb.checked = false);
        updateCount();
    };
    
    window.selectByTransaction = selectByTransaction;
    
    // Initial count
    updateCount();
});
</script>
{% endblock %}